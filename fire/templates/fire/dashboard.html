{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Fire Management Dashboard{% endblock title %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock vendor_css %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Overview Stats -->
    <div class="row">
        <div class="col-lg-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-wrap">
                        <div class="card-title mb-0">
                            <h5 class="mb-1"><i class="bi bi-fire me-2"></i>Active Incidents</h5>
                            <small class="text-muted">Last 24 hours</small>
                        </div>
                        <div class="avatar">
                            <div class="avatar-content bg-danger">
                                <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                            </div>
                        </div>
                    </div>
                    <h3 class="fw-bold mt-3 mb-1">{{ active_incidents }}</h3>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-wrap">
                        <div class="card-title mb-0">
                            <h5 class="mb-1"><i class="bi bi-building me-2"></i>Total Stations</h5>
                            <small class="text-muted">Fire Stations</small>
                        </div>
                        <div class="avatar">
                            <div class="avatar-content bg-primary">
                                <i class="bi bi-building-fill fs-4"></i>
                            </div>
                        </div>
                    </div>
                    <h3 class="fw-bold mt-3 mb-1">{{ total_stations }}</h3>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-wrap">
                        <div class="card-title mb-0">
                            <h5 class="mb-1"><i class="bi bi-people me-2"></i>Total Firefighters</h5>
                            <small class="text-muted">Active Personnel</small>
                        </div>
                        <div class="avatar">
                            <div class="avatar-content bg-success">
                                <i class="bi bi-person-badge-fill fs-4"></i>
                            </div>
                        </div>
                    </div>
                    <h3 class="fw-bold mt-3 mb-1">{{ total_firefighters }}</h3>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-wrap">
                        <div class="card-title mb-0">
                            <h5 class="mb-1"><i class="bi bi-truck me-2"></i>Total Trucks</h5>
                            <small class="text-muted">Fire Trucks</small>
                        </div>
                        <div class="avatar">
                            <div class="avatar-content bg-warning">
                                <i class="bi bi-truck-flatbed-fill fs-4"></i>
                            </div>
                        </div>
                    </div>
                    <h3 class="fw-bold mt-3 mb-1">{{ total_trucks }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Weather and Recent Incidents -->
    <div class="row">
        <!-- Weather Card -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-cloud-sun-fill me-2"></i>Weather Conditions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h3 class="mb-1"><i class="bi bi-thermometer-half me-2"></i>{{ weather.temperature }}Â°C</h3>
                            <p class="text-muted mb-0"><i class="bi bi-cloud me-2"></i>{{ weather.weather_description }}</p>
                        </div>
                        <div class="text-end">
                            <p class="mb-1"><i class="bi bi-droplet-fill me-1"></i>Humidity: {{ weather.humidity }}%</p>
                            <p class="mb-0"><i class="bi bi-wind me-1"></i>Wind: {{ weather.wind_speed }} km/h</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Incidents -->
        <div class="col-lg-8 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Recent Incidents
                    </h5>
                    <a href="{% url 'fire:incident_list' %}" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-circle me-1"></i>New Incident
                    </a>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><i class="bi bi-geo-alt me-1"></i>Location</th>
                                <th><i class="bi bi-flag me-1"></i>Severity</th>
                                <th><i class="bi bi-clock me-1"></i>Time</th>
                                <th><i class="bi bi-gear me-1"></i>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for incident in recent_incidents %}
                            <tr>
                                <td><i class="bi bi-geo-alt-fill me-1"></i>{{ incident.location.name }}</td>
                                <td>
                                    <span class="badge bg-{{ incident.severity_level|lower }}-subtle text-{{ incident.severity_level|lower }}">
                                        <i class="bi bi-flag-fill me-1"></i>{{ incident.severity_level }}
                                    </span>
                                </td>
                                <td><i class="bi bi-clock-fill me-1"></i>{{ incident.date_time|date:"M d, H:i" }}</td>
                                <td>
                                    <a href="{% url 'fire:incident_detail' incident.id %}" class="btn btn-sm btn-icon btn-text-secondary rounded-pill" title="View Details">
                                        <i class="bi bi-eye-fill"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Maps -->
    <div class="row">
        <!-- Incident Statistics -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bar-chart-fill me-2"></i>Incident Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div id="incidentChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- Fire Station Statistics -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-building-fill me-2"></i>Station Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div id="stationChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fire Stations Map -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-map-fill me-2"></i>Fire Stations Map
                    </h5>
                    <a href="{% url 'fire:station_create' %}" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-circle me-1"></i>Add Station
                    </a>
                </div>
                <div class="card-body">
                    <div id="stationsMap" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block vendor_js %}
{{ block.super }}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock vendor_js %}

{% block page_js %}
<script>
    // Initialize maps
    const stationsMap = L.map('stationsMap').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(stationsMap);

    // Add station markers with custom icons
    const fireStationIcon = L.divIcon({
        html: '<i class="bi bi-building-fill text-danger fs-4"></i>',
        className: 'custom-div-icon',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
    });

    {% for station in stations %}
    L.marker([{{ station.latitude }}, {{ station.longitude }}], {icon: fireStationIcon})
        .bindPopup(`
            <div class="text-center">
                <i class="bi bi-building-fill text-danger fs-4 mb-2"></i>
                <h6 class="mb-1"><b>{{ station.name }}</b></h6>
                <p class="mb-0 small">{{ station.address }}</p>
            </div>
        `)
        .addTo(stationsMap);
    {% endfor %}

    // Incident Statistics Chart
    const incidentOptions = {
        series: [{
            name: 'Incidents',
            data: [
                {% for stat in incident_stats %}
                {{ stat.count }},
                {% endfor %}
            ]
        }],
        chart: {
            type: 'bar',
            height: 300
        },
        plotOptions: {
            bar: {
                borderRadius: 4,
                horizontal: true,
            }
        },
        dataLabels: {
            enabled: false
        },
        xaxis: {
            categories: [
                {% for stat in incident_stats %}
                '{{ stat.severity_level }}',
                {% endfor %}
            ],
        }
    };
    new ApexCharts(document.querySelector("#incidentChart"), incidentOptions).render();

    // Station Statistics Chart
    const stationOptions = {
        series: [{
            name: 'Firefighters',
            data: [
                {% for stat in station_stats %}
                {{ stat.firefighters_count }},
                {% endfor %}
            ]
        }],
        chart: {
            type: 'bar',
            height: 300
        },
        plotOptions: {
            bar: {
                borderRadius: 4,
                horizontal: true,
            }
        },
        dataLabels: {
            enabled: false
        },
        xaxis: {
            categories: [
                {% for stat in station_stats %}
                '{{ stat.name }}',
                {% endfor %}
            ],
        }
    };
    new ApexCharts(document.querySelector("#stationChart"), stationOptions).render();
</script>
{% endblock %} 