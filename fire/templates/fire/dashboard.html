{% extends 'layouts/master.html' %}

{% load static %}
{% load i18n %}

{% block title %}Dashboard{% endblock title %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock vendor_css %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <h4 class="fw-bold py-3 mb-4">
        <span class="text-muted fw-light">Fire Management /</span> Dashboard
    </h4>

    <!-- Overview Cards -->
    <div class="row">
        <div class="col-lg-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-wrap">
                        <div class="card-title mb-0">
                            <h5 class="mb-1">Active Incidents</h5>
                            <small class="text-muted">Last 24 hours</small>
                        </div>
                        <div class="avatar">
                            <div class="avatar-content bg-label-primary">
                                <i class="bi bi-fire text-primary fs-4"></i>
                            </div>
                        </div>
                    </div>
                    <h3 class="mt-4 mb-2">{{ active_incidents }}</h3>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-wrap">
                        <div class="card-title mb-0">
                            <h5 class="mb-1">Total Stations</h5>
                            <small class="text-muted">All stations</small>
                        </div>
                        <div class="avatar">
                            <div class="avatar-content bg-label-success">
                                <i class="bi bi-building text-success fs-4"></i>
                            </div>
                        </div>
                    </div>
                    <h3 class="mt-4 mb-2">{{ total_stations }}</h3>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-wrap">
                        <div class="card-title mb-0">
                            <h5 class="mb-1">Total Firefighters</h5>
                            <small class="text-muted">All personnel</small>
                        </div>
                        <div class="avatar">
                            <div class="avatar-content bg-label-warning">
                                <i class="bi bi-people text-warning fs-4"></i>
                            </div>
                        </div>
                    </div>
                    <h3 class="mt-4 mb-2">{{ total_firefighters }}</h3>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-wrap">
                        <div class="card-title mb-0">
                            <h5 class="mb-1">Total Trucks</h5>
                            <small class="text-muted">All vehicles</small>
                        </div>
                        <div class="avatar">
                            <div class="avatar-content bg-label-info">
                                <i class="bi bi-truck text-info fs-4"></i>
                            </div>
                        </div>
                    </div>
                    <h3 class="mt-4 mb-2">{{ total_trucks }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Incidents -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Incidents</h5>
                    <a href="{% url 'fire:incident_list' %}" class="btn btn-primary btn-sm">
                        <i class="bi bi-list me-1"></i> View All
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Location</th>
                                    <th>Date & Time</th>
                                    <th>Severity</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody class="table-border-bottom-0">
                                {% for incident in recent_incidents %}
                                <tr>
                                    <td><strong>#{{ incident.id }}</strong></td>
                                    <td>{{ incident.location.name }}</td>
                                    <td>{{ incident.date_time|default:"Not set" }}</td>
                                    <td>
                                        {% if incident.severity_level == 'Minor Fire' %}
                                        <span class="badge bg-label-success">
                                            <i class="bi bi-circle-fill me-1"></i> Minor
                                        </span>
                                        {% elif incident.severity_level == 'Moderate Fire' %}
                                        <span class="badge bg-label-warning">
                                            <i class="bi bi-circle-fill me-1"></i> Moderate
                                        </span>
                                        {% else %}
                                        <span class="badge bg-label-danger">
                                            <i class="bi bi-circle-fill me-1"></i> Major
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>{{ incident.description|truncatechars:50 }}</td>
                                    <td>
                                        <div class="d-flex gap-2">
                                            <a href="{% url 'fire:incident_detail' incident.pk %}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="View Details">
                                                <i class="bi bi-eye me-1"></i> View
                                            </a>
                                            <a href="{% url 'fire:incident_edit' incident.pk %}" class="btn btn-sm btn-outline-secondary" data-bs-toggle="tooltip" title="Edit Incident">
                                                <i class="bi bi-pencil me-1"></i> Edit
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">No recent incidents found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Weather and Statistics -->
    <div class="row">
        <!-- Weather Card -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-cloud-sun-fill me-2 text-warning"></i>Weather Conditions
                    </h5>
                    <span class="badge bg-label-info">Live</span>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-column align-items-center text-center mb-4">
                        <div class="display-4 mb-2">
                            <i class="bi bi-thermometer-half text-danger"></i>
                            {{ weather.temperature }}°C
                        </div>
                        <div class="text-muted mb-3">
                            <i class="bi bi-cloud me-2"></i>{{ weather.weather_description }}
                        </div>
                    </div>
                    <div class="d-flex justify-content-around">
                        <div class="text-center">
                            <div class="mb-1">
                                <i class="bi bi-droplet-fill text-primary fs-4"></i>
                            </div>
                            <h6 class="mb-0">Humidity</h6>
                            <small class="text-muted">{{ weather.humidity }}%</small>
                        </div>
                        <div class="text-center">
                            <div class="mb-1">
                                <i class="bi bi-wind text-info fs-4"></i>
                            </div>
                            <h6 class="mb-0">Wind Speed</h6>
                            <small class="text-muted">{{ weather.wind_speed }} km/h</small>
                        </div>
                        <div class="text-center">
                            <div class="mb-1">
                                <i class="bi bi-compass text-success fs-4"></i>
                            </div>
                            <h6 class="mb-0">Direction</h6>
                            <small class="text-muted">{{ weather.wind_direction }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="col-lg-8 col-md-6 mb-4">
            <!-- Incident Statistics -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bar-chart-fill me-2 text-primary"></i>Incident Statistics
                    </h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-calendar3 me-1"></i>Last 30 Days
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">Last 7 Days</a></li>
                            <li><a class="dropdown-item" href="#">Last 30 Days</a></li>
                            <li><a class="dropdown-item" href="#">Last 90 Days</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div id="incidentChart" style="height: 300px;"></div>
                </div>
            </div>

            <!-- Station Statistics -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-building-fill me-2 text-success"></i>Station Statistics
                    </h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary active">Personnel</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary">Equipment</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="stationChart" style="height: 300px;"></div>
                </div>
            </div>

            <!-- Fire Stations Map -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-map-fill me-2 text-danger"></i>Fire Stations Map
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-secondary" id="zoomIn">
                            <i class="bi bi-zoom-in"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="zoomOut">
                            <i class="bi bi-zoom-out"></i>
                        </button>
                        <a href="{% url 'fire:station_create' %}" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus-circle me-1"></i>Add Station
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div id="stationsMap" style="height: 400px; border-radius: 0.375rem;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block vendor_js %}
{{ block.super }}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock vendor_js %}

{% block page_js %}
<script>
    // Initialize maps with better styling
    const stationsMap = L.map('stationsMap', {
        zoomControl: false,
        scrollWheelZoom: true
    }).setView([0, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(stationsMap);

    // Custom map controls
    L.control.zoom({
        position: 'bottomright'
    }).addTo(stationsMap);

    // Add station markers with custom icons
    const fireStationIcon = L.divIcon({
        html: '<i class="bi bi-building-fill text-danger fs-4"></i>',
        className: 'custom-div-icon',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
    });

    {% for station in stations %}
    L.marker([{{ station.latitude }}, {{ station.longitude }}], {icon: fireStationIcon})
        .bindPopup(`
            <div class="text-center p-2">
                <i class="bi bi-building-fill text-danger fs-4 mb-2"></i>
                <h6 class="mb-1"><b>{{ station.name }}</b></h6>
                <p class="mb-1 small">{{ station.address }}</p>
                <div class="d-flex justify-content-center gap-2 mt-2">
                    <a href="{% url 'fire:station_detail' station.pk %}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye me-1"></i>View
                    </a>
                    <a href="{% url 'fire:station_edit' station.pk %}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-pencil me-1"></i>Edit
                    </a>
                </div>
            </div>
        `)
        .addTo(stationsMap);
    {% endfor %}

    // Incident Statistics Chart with better styling
    const incidentOptions = {
        series: [{
            name: 'Incidents',
            data: [
                {% for stat in incident_stats %}
                {{ stat.count }},
                {% endfor %}
            ]
        }],
        chart: {
            type: 'bar',
            height: 300,
            toolbar: {
                show: false
            }
        },
        plotOptions: {
            bar: {
                borderRadius: 4,
                horizontal: true,
                distributed: true,
                dataLabels: {
                    position: 'bottom'
                }
            }
        },
        colors: ['#1d7af3', '#fdaf4b', '#f3545d'],
        dataLabels: {
            enabled: true,
            formatter: function (val) {
                return val + " incidents"
            },
            style: {
                fontSize: '12px',
                colors: ['#333']
            }
        },
        xaxis: {
            categories: [
                {% for stat in incident_stats %}
                '{{ stat.severity_level }}',
                {% endfor %}
            ],
        },
        legend: {
            show: false
        }
    };
    new ApexCharts(document.querySelector("#incidentChart"), incidentOptions).render();

    // Station Statistics Chart with better styling
    const stationOptions = {
        series: [{
            name: 'Firefighters',
            data: [
                {% for stat in station_stats %}
                {{ stat.firefighters_count }},
                {% endfor %}
            ]
        }],
        chart: {
            type: 'bar',
            height: 300,
            toolbar: {
                show: false
            }
        },
        plotOptions: {
            bar: {
                borderRadius: 4,
                horizontal: true,
                dataLabels: {
                    position: 'bottom'
                }
            }
        },
        colors: ['#1d7af3'],
        dataLabels: {
            enabled: true,
            formatter: function (val) {
                return val + " firefighters"
            },
            style: {
                fontSize: '12px',
                colors: ['#333']
            }
        },
        xaxis: {
            categories: [
                {% for stat in station_stats %}
                '{{ stat.name }}',
                {% endfor %}
            ],
        },
        legend: {
            show: false
        }
    };
    new ApexCharts(document.querySelector("#stationChart"), stationOptions).render();

    // Initialize tooltips
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // Map zoom controls
        document.getElementById('zoomIn').addEventListener('click', function() {
            stationsMap.zoomIn();
        });
        document.getElementById('zoomOut').addEventListener('click', function() {
            stationsMap.zoomOut();
        });
    });
</script>
{% endblock page_js %} 